<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MethodProbe ç®¡ç†æ§åˆ¶å°</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px 30px;
            background: #f0f2f5;
        }

        h1 {
            color: #1a1a2e;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 24px;
        }

        .row {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
            min-width: 350px;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -20px -20px 20px -20px;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            color: #fff;
        }

        .card.flat .card-header {
            background: linear-gradient(135deg, #4a90d9, #357abd);
        }

        .card.tree .card-header {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }

        .card.snapshot .card-header {
            background: linear-gradient(135deg, #6c757d, #545b62);
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        input,
        select {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4a90d9;
        }

        input[type="text"],
        input[type="number"] {
            flex: 1;
            min-width: 0;
        }

        button {
            padding: 10px 18px;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-flat {
            background: #4a90d9;
        }

        .btn-tree {
            background: #28a745;
        }

        .btn-snap {
            background: #6c757d;
        }

        .btn-exception {
            background: #dc3545;
        }

        .btn-refresh {
            background: #17a2b8;
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-delete {
            background: #dc3545;
            padding: 4px 10px;
            font-size: 12px;
            margin-left: 6px;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            min-height: 32px;
            max-height: 150px;
            overflow-y: auto;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            max-width: 100%;
            word-break: break-all;
        }

        .tag .del {
            margin-left: 8px;
            color: #dc3545;
            cursor: pointer;
            font-weight: bold;
        }

        .tag .del:hover {
            color: #a71d2a;
        }

        .section {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-on {
            background: #d4edda;
            color: #155724;
        }

        .status-off {
            background: #f8d7da;
            color: #721c24;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .config-label {
            color: #666;
        }

        .config-value {
            font-weight: 600;
            color: #333;
            word-break: break-all;
            text-align: right;
            max-width: 60%;
        }

        #toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 14px 24px;
            background: #28a745;
            color: #fff;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #toast.error {
            background: #dc3545;
        }

        .trigger-row {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-top: 8px;
        }

        .trigger-row label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .trigger-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .trigger-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .trigger-timeout {
            background: #fff3cd;
            color: #856404;
        }

        .trigger-exception {
            background: #cce5ff;
            color: #004085;
        }

        .empty-text {
            color: #999;
            font-style: italic;
            font-size: 13px;
        }

        hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid #eee;
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .info-card .config-item {
            border-bottom: 1px solid #e9ecef;
        }

        .info-card .config-item:last-child {
            border-bottom: none;
        }

        .help-tip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 6px;
            background: #e0e0e0;
            color: #666;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .help-tip:hover {
            background: #4a90d9;
            color: #fff;
        }

        .help-tip:hover::after {
            content: attr(data-tip);
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #333;
            color: #fff;
            font-size: 12px;
            font-weight: normal;
            border-radius: 6px;
            z-index: 1000;
            min-width: 200px;
            max-width: 400px;
            width: max-content;
            white-space: normal;
            text-align: left;
            line-height: 1.4;
        }

        .help-tip:hover::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translateX(-50%);
            margin-bottom: 2px;
            border: 6px solid transparent;
            border-top-color: #333;
        }

        /* Section Header */
        .section-header {
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .section-header h2 {
            font-size: 20px;
            color: #2c3e50;
            margin: 0;
            display: inline-block;
        }

        .section-desc {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        .dependency-hint {
            display: inline-block;
            background: #e9ecef;
            color: #666;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <h1>
        <span>MethodProbe ç®¡ç†æ§åˆ¶å°</span>
        <div>
            <a href="/log" target="_blank" style="text-decoration:none; background:#2c3e50; color:#fff; font-size:14px; padding:8px 16px; border-radius:6px; margin-right:10px; display:inline-block; vertical-align:middle;">ğŸ“º å®æ—¶æ—¥å¿—</a>
            <button class="btn-refresh" onclick="loadConfig()">ğŸ”„ åˆ·æ–°é…ç½®</button>
        </div>
    </h1>

    <!-- Section: Core Modes -->
    <div class="section-header">
        <h2>ğŸš€ æ ¸å¿ƒç›‘æ§æ¨¡å¼</h2>
        <div class="section-desc">é€‰æ‹©å¹¶é…ç½®ä¸»è¦çš„æ–¹æ³•è·Ÿè¸ªæ¨¡å¼ (Flat / Tree)</div>
    </div>

    <div class="row">
        <!-- Flat æ¨¡å¼ -->
        <div class="col">
            <div class="card flat">
                <div class="card-header">
                    <h3>ğŸ“Š Flat æ¨¡å¼</h3>
                    <span id="flatStatus"></span>
                </div>

                <div class="section">
                    <div class="config-item"><span class="config-label">é˜ˆå€¼<span class="help-tip"
                                data-tip="æ–¹æ³•æ‰§è¡Œæ—¶é—´è¶…è¿‡æ­¤å€¼(ms)æ—¶è®°å½•æ—¥å¿—">?</span></span><span class="config-value"
                            id="flatThresholdVal">-</span></div>
                    <div class="config-item"><span class="config-label">è§¦å‘<span class="help-tip"
                                data-tip="å½“è¶…æ—¶æˆ–å¼‚å¸¸å‘ç”Ÿæ—¶è§¦å‘è®°å½•">?</span></span><span id="flatTriggerBadges">-</span></div>
                </div>

                <div class="section">
                    <div class="section-title">ç›‘æ§åŒ…<span class="help-tip" data-tip="åŒ…åå‰ç¼€ï¼Œè¯¥åŒ…ä¸‹æ‰€æœ‰ç±»çš„æ–¹æ³•éƒ½ä¼šè¢«ç›‘æ§">?</span></div>
                    <div class="tag-list" id="flatPackageList"></div>
                </div>

                <div class="section">
                    <div class="section-title">ç›‘æ§ç±»<span class="help-tip" data-tip="å®Œæ•´ç±»åï¼Œè¯¥ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«ç›‘æ§">?</span></div>
                    <div class="tag-list" id="flatClassList"></div>
                </div>

                <hr>

                <div class="form-group">
                    <label>æ·»åŠ ç±»<span class="help-tip" data-tip="è¾“å…¥å®Œæ•´ç±»åï¼Œå¦‚ com.example.MyClass">?</span></label>
                    <div class="form-row">
                        <input type="text" id="flatClass" placeholder="com.example.MyClass">
                        <button class="btn-flat" onclick="flatClassAdd()">æ·»åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ·»åŠ åŒ…<span class="help-tip" data-tip="è¾“å…¥åŒ…åå‰ç¼€ï¼Œå¦‚ com.example">?</span></label>
                    <div class="form-row">
                        <input type="text" id="flatPackage" placeholder="com.example">
                        <button class="btn-flat" onclick="flatPackageAdd()">æ·»åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="config-grid">
                        <div>
                            <label>é˜ˆå€¼ (ms)<span class="help-tip" data-tip="æ–¹æ³•æ‰§è¡Œæ—¶é—´è¶…è¿‡æ­¤å€¼æ—¶è§¦å‘è®°å½•">?</span></label>
                            <input type="number" id="flatThreshold" placeholder="100" min="0" style="width:100%;">
                        </div>
                        <div>
                            <label>è§¦å‘æ¡ä»¶<span class="help-tip" data-tip="é€‰æ‹©ä½•æ—¶è§¦å‘æ—¥å¿—è®°å½•">?</span></label>
                            <select id="flatTrigger" style="width:100%;">
                                <option value="timeout">è¶…æ—¶è§¦å‘</option>
                                <option value="exception">å¼‚å¸¸è§¦å‘</option>
                                <option value="both">è¶…æ—¶+å¼‚å¸¸</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn-flat" onclick="flatConfigSave()" style="width:100%;">ğŸ’¾ ä¿å­˜ Flat é…ç½®</button>
            </div>
        </div>

        <!-- Tree æ¨¡å¼ -->
        <div class="col">
            <div class="card tree">
                <div class="card-header">
                    <h3>ğŸŒ³ Tree æ¨¡å¼</h3>
                    <span id="treeStatus"></span>
                </div>

                <div class="section">
                    <div class="config-item"><span class="config-label">é˜ˆå€¼<span class="help-tip"
                                data-tip="è°ƒç”¨é“¾æ‰§è¡Œæ—¶é—´è¶…è¿‡æ­¤å€¼(ms)æ—¶è®°å½•æ—¥å¿—">?</span></span><span class="config-value"
                            id="treeThresholdVal">-</span></div>
                    <div class="config-item"><span class="config-label">è§¦å‘<span class="help-tip"
                                data-tip="å½“è¶…æ—¶æˆ–å¼‚å¸¸å‘ç”Ÿæ—¶è§¦å‘è®°å½•">?</span></span><span id="treeTriggerBadges">-</span></div>
                </div>

                <div class="section">
                    <div class="section-title">å…¥å£æ–¹æ³•<span class="help-tip" data-tip="è°ƒç”¨é“¾çš„èµ·å§‹æ–¹æ³•ï¼Œä»æ­¤å¼€å§‹è·Ÿè¸ª">?</span></div>
                    <div class="tag-list" id="treeEntryList"></div>
                </div>

                <div class="section">
                    <div class="section-title">ç›‘æ§åŒ…<span class="help-tip" data-tip="åŒ…åå‰ç¼€ï¼Œåªè·Ÿè¸ªè¯¥åŒ…ä¸‹çš„æ–¹æ³•è°ƒç”¨">?</span></div>
                    <div class="tag-list" id="treePackageList"></div>
                </div>

                <hr>

                <div class="form-group">
                    <label>æ·»åŠ å…¥å£æ–¹æ³•<span class="help-tip"
                            data-tip="æ ¼å¼: ç±»å.æ–¹æ³•åï¼Œå¦‚ com.example.Controller.handle">?</span></label>
                    <div class="form-row">
                        <input type="text" id="treeEntry" placeholder="com.example.Controller.handle">
                        <button class="btn-tree" onclick="treeEntryAdd()">æ·»åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ·»åŠ åŒ…<span class="help-tip" data-tip="åŒ…åå‰ç¼€ï¼Œåªè®°å½•è¯¥åŒ…ä¸‹çš„æ–¹æ³•è°ƒç”¨">?</span></label>
                    <div class="form-row">
                        <input type="text" id="treePackage" placeholder="com.example">
                        <button class="btn-tree" onclick="treePackageAdd()">æ·»åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="config-grid">
                        <div>
                            <label>é˜ˆå€¼ (ms)<span class="help-tip" data-tip="è°ƒç”¨é“¾æ‰§è¡Œæ—¶é—´è¶…è¿‡æ­¤å€¼æ—¶è§¦å‘è®°å½•">?</span></label>
                            <input type="number" id="treeThreshold" placeholder="100" min="0" style="width:100%;">
                        </div>
                        <div>
                            <label>è§¦å‘æ¡ä»¶<span class="help-tip" data-tip="é€‰æ‹©ä½•æ—¶è§¦å‘è°ƒç”¨é“¾è®°å½•">?</span></label>
                            <select id="treeTrigger" style="width:100%;">
                                <option value="timeout">è¶…æ—¶è§¦å‘</option>
                                <option value="exception">å¼‚å¸¸è§¦å‘</option>
                                <option value="both">è¶…æ—¶+å¼‚å¸¸</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn-tree" onclick="treeConfigSave()" style="width:100%;">ğŸ’¾ ä¿å­˜ Tree é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Section: Extensions -->
    <div class="section-header">
        <h2>ğŸ”Œ æ‰©å±•é…ç½®</h2>
        <div class="section-desc">é…åˆæ ¸å¿ƒæ¨¡å¼ä½¿ç”¨ï¼Œæä¾›æ›´ç²¾ç»†çš„æ§åˆ¶ (Exception Filter / Snapshot)</div>
    </div>

    <!-- Row 2: Exception Filter + Snapshot -->
    <div class="row">
        <!-- å¼‚å¸¸è¿‡æ»¤å™¨ -->
        <div class="col">
            <div class="card exception">
                <div class="card-header" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                    <h3>âš ï¸ å¼‚å¸¸è¿‡æ»¤å™¨<span class="dependency-hint">â¬† ä¾èµ–ä¸Šæ–¹æ•°æ®æº</span></h3>
                </div>

                <div class="section">
                    <div class="config-item"><span class="config-label">å †æ ˆæ·±åº¦<span class="help-tip"
                                data-tip="å¼‚å¸¸å †æ ˆè·Ÿè¸ªçš„æœ€å¤§å±‚æ•°">?</span></span><span class="config-value"
                            id="exceptionDepthVal">-</span></div>
                </div>

                <div class="section">
                    <div class="section-title">åŒ…å«å¼‚å¸¸ (ç©º=å…¨éƒ¨)<span class="help-tip" data-tip="åªè®°å½•è¿™äº›ç±»å‹çš„å¼‚å¸¸ï¼Œç©ºè¡¨ç¤ºå…¨éƒ¨">?</span>
                    </div>
                    <div class="tag-list" id="exceptionIncludeList"></div>
                </div>

                <div class="section">
                    <div class="section-title">æ’é™¤å¼‚å¸¸ (ä¼˜å…ˆ)<span class="help-tip" data-tip="è¿™äº›ç±»å‹çš„å¼‚å¸¸ä¸ä¼šè¢«è®°å½•">?</span></div>
                    <div class="tag-list" id="exceptionExcludeList"></div>
                </div>

                <hr>

                <div class="form-group">
                    <label>æ·»åŠ åŒ…å«å¼‚å¸¸<span class="help-tip"
                            data-tip="å¼‚å¸¸ç±»å®Œæ•´åç§°ï¼Œå¦‚ java.lang.NullPointerException">?</span></label>
                    <div class="form-row">
                        <input type="text" id="exceptionInclude" placeholder="java.lang.NullPointerException">
                        <button class="btn-exception" onclick="exceptionIncludeAdd()">æ·»åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ·»åŠ æ’é™¤å¼‚å¸¸<span class="help-tip" data-tip="å¼‚å¸¸ç±»å®Œæ•´åç§°ï¼Œè¿™äº›å¼‚å¸¸å°†è¢«å¿½ç•¥">?</span></label>
                    <div class="form-row">
                        <input type="text" id="exceptionExclude" placeholder="java.lang.IllegalArgumentException">
                        <button class="btn-exception" onclick="exceptionExcludeAdd()">æ·»åŠ </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>å †æ ˆæ·±åº¦<span class="help-tip" data-tip="å¼‚å¸¸å †æ ˆæ˜¾ç¤ºçš„æœ€å¤§å±‚æ•°">?</span></label>
                    <div class="form-row">
                        <input type="number" id="exceptionDepth" placeholder="10" min="1" max="100">
                        <button class="btn-exception" onclick="exceptionDepthSet()">è®¾ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¿«ç…§é…ç½® -->
        <div class="col">
            <div class="card snapshot">
                <div class="card-header">
                    <h3>ğŸ“¸ å¿«ç…§é…ç½®<span class="dependency-hint">â¬† ä¾èµ–ä¸Šæ–¹æ•°æ®æº</span></h3>
                    <span id="snapshotStatus"></span>
                </div>

                <div class="section">
                    <div class="config-item"><span class="config-label">ç›®å½•<span class="help-tip"
                                data-tip="å¿«ç…§æ–‡ä»¶å­˜å‚¨ç›®å½•">?</span></span><span class="config-value"
                            id="snapshotDirVal">-</span></div>
                    <div class="config-item"><span class="config-label">åºåˆ—åŒ–<span class="help-tip"
                                data-tip="åŒæ­¥æˆ–å¼‚æ­¥åºåˆ—åŒ–å¿«ç…§æ•°æ®">?</span></span><span class="config-value"
                            id="snapshotModeVal">-</span></div>
                    <div class="config-item"><span class="config-label">æœ€å¤§å¯¹è±¡<span class="help-tip"
                                data-tip="å•ä¸ªå¯¹è±¡åºåˆ—åŒ–çš„æœ€å¤§å¤§å°é™åˆ¶">?</span></span><span class="config-value"
                            id="snapshotMaxVal">-</span></div>
                    <div class="config-item"><span class="config-label">ä¿ç•™å¤©æ•°<span class="help-tip"
                                data-tip="å¿«ç…§æ–‡ä»¶ä¿ç•™å¤©æ•°ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ é™¤">?</span></span><span class="config-value"
                            id="snapshotRetentionVal">-</span></div>
                </div>

                <hr>

                <div class="form-group">
                    <div class="config-grid">
                        <div>
                            <label>å¯ç”¨çŠ¶æ€<span class="help-tip" data-tip="å¯ç”¨æˆ–ç¦ç”¨å¿«ç…§åŠŸèƒ½">?</span></label>
                            <select id="snapshotEnabled" style="width:100%;">
                                <option value="true">å¯ç”¨</option>
                                <option value="false">ç¦ç”¨</option>
                            </select>
                        </div>
                        <div>
                            <label>åºåˆ—åŒ–æ¨¡å¼<span class="help-tip" data-tip="å¼‚æ­¥æ€§èƒ½æ›´å¥½ï¼ŒåŒæ­¥ä¿è¯ä¸€è‡´æ€§">?</span></label>
                            <select id="snapshotMode" style="width:100%;">
                                <option value="sync">åŒæ­¥</option>
                                <option value="async">å¼‚æ­¥</option>
                            </select>
                        </div>
                        </div>
                        <!-- Snapshot Dir input removed as it is immutable -->
                    </div>
                </div>


                <button class="btn-snap" onclick="snapshotSave()" style="width:100%;">ä¿å­˜å¿«ç…§é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Section: System -->
    <div class="section-header">
        <h2>â„¹ï¸ ç³»ç»ŸçŠ¶æ€</h2>
        <div class="section-desc">å½“å‰ä»£ç†è¿è¡ŒçŠ¶æ€ä¸åŸºæœ¬ä¿¡æ¯</div>
    </div>

    <!-- Row 3: System Info -->
    <div class="row">
        <div class="col">
            <div class="card info-card">
                <div class="section-title" style="margin-bottom: 12px;">ğŸ“‹ ç³»ç»Ÿä¿¡æ¯</div>
                <div class="config-item"><span class="config-label">HTTP ç«¯å£<span class="help-tip"
                            data-tip="ç®¡ç†æ¥å£çš„HTTPç«¯å£">?</span></span><span class="config-value" id="httpPort">-</span>
                </div>
                <div class="config-item"><span class="config-label">è¾“å‡ºæ¨¡å¼<span class="help-tip"
                            data-tip="æ—¥å¿—è¾“å‡ºæ–¹å¼: console/file/both">?</span></span><span class="config-value"
                        id="outputMode">-</span></div>
                <div class="config-item"><span class="config-label">è¾“å‡ºç›®å½•<span class="help-tip"
                            data-tip="æ—¥å¿—æ–‡ä»¶å­˜å‚¨ç›®å½•">?</span></span><span class="config-value" id="outputDir">-</span></div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = isError ? 'error' : '';
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function statusBadge(enabled) {
            return `<span class="status ${enabled ? 'status-on' : 'status-off'}">${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>`;
        }

        function triggerBadge(trigger) {
            const map = {
                'timeout': '<span class="trigger-badge trigger-timeout">è¶…æ—¶</span>',
                'exception': '<span class="trigger-badge trigger-exception">å¼‚å¸¸</span>',
                'both': '<span class="trigger-badge trigger-timeout">è¶…æ—¶</span> <span class="trigger-badge trigger-exception">å¼‚å¸¸</span>'
            };
            return map[trigger] || '<span class="empty-text">æ— </span>';
        }

        function tagWithDelete(text, deleteCallback) {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.innerHTML = `${text}<span class="del" title="åˆ é™¤">Ã—</span>`;
            tag.querySelector('.del').onclick = deleteCallback;
            return tag;
        }

        function renderTags(container, items, deleteUrl, paramName) {
            container.innerHTML = '';
            if (!items || items.length === 0) {
                container.innerHTML = '<span class="empty-text">æ— </span>';
                return;
            }
            items.forEach(item => {
                container.appendChild(tagWithDelete(item, () => deleteItem(deleteUrl, paramName, item)));
            });
        }

        async function deleteItem(url, paramName, value) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ "${value}"?`)) return;
            await post(url, `${paramName}=${encodeURIComponent(value)}`);
        }

        async function loadConfig() {
            try {
                const res = await fetch('/config');
                const cfg = await res.json();
                displayConfig(cfg);
            } catch (e) {
                showToast('åŠ è½½å¤±è´¥: ' + e.message, true);
            }
        }

        function displayConfig(cfg) {
            // Flat
            document.getElementById('flatStatus').innerHTML = statusBadge(cfg.flat.enabled);
            document.getElementById('flatThresholdVal').textContent = cfg.flat.thresholdMs + ' ms';
            document.getElementById('flatThreshold').value = cfg.flat.thresholdMs;
            document.getElementById('flatTriggerBadges').innerHTML = triggerBadge(cfg.flat.trigger);
            document.getElementById('flatTrigger').value = cfg.flat.trigger;
            renderTags(document.getElementById('flatPackageList'), cfg.flat.packages, '/flat/package/remove', 'packageName');
            renderTags(document.getElementById('flatClassList'), cfg.flat.classes, '/flat/class/remove', 'className');

            // Tree
            document.getElementById('treeStatus').innerHTML = statusBadge(cfg.tree.enabled);
            document.getElementById('treeThresholdVal').textContent = cfg.tree.thresholdMs + ' ms';
            document.getElementById('treeThreshold').value = cfg.tree.thresholdMs;
            document.getElementById('treeTriggerBadges').innerHTML = triggerBadge(cfg.tree.trigger);
            document.getElementById('treeTrigger').value = cfg.tree.trigger;
            renderTags(document.getElementById('treeEntryList'), cfg.tree.entryMethods, '/tree/entry/remove', 'method');
            renderTags(document.getElementById('treePackageList'), cfg.tree.packages, '/tree/package/remove', 'packageName');

            // Snapshot
            document.getElementById('snapshotStatus').innerHTML = statusBadge(cfg.snapshot.enabled);
            document.getElementById('snapshotDirVal').textContent = cfg.snapshot.dir;
            document.getElementById('snapshotModeVal').textContent = cfg.snapshot.serializeSync ? 'åŒæ­¥' : 'å¼‚æ­¥';
            document.getElementById('snapshotMaxVal').textContent = (cfg.snapshot.maxObjectSize / 1024 / 1024).toFixed(1) + ' MB';
            document.getElementById('snapshotRetentionVal').textContent = cfg.snapshot.retentionDays + ' å¤©';
            document.getElementById('snapshotEnabled').value = cfg.snapshot.enabled ? 'true' : 'false';
            document.getElementById('snapshotMode').value = cfg.snapshot.serializeSync ? 'sync' : 'async';

            // General
            document.getElementById('httpPort').textContent = cfg.general.httpPort;
            document.getElementById('outputMode').textContent = cfg.output.mode;
            document.getElementById('outputDir').textContent = cfg.output.dir;

            // Exception
            document.getElementById('exceptionDepthVal').textContent = cfg.exception.stackDepth;
            renderTags(document.getElementById('exceptionIncludeList'),
                Array.from(cfg.exception.include || []), '/exception/include/remove', 'pattern');
            renderTags(document.getElementById('exceptionExcludeList'),
                Array.from(cfg.exception.exclude || []), '/exception/exclude/remove', 'pattern');
        }

        async function post(url, body, skipReload) {
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body
                });
                const r = await res.json();
                if (r.success) { 
                    if (!skipReload) {
                        showToast('æ“ä½œæˆåŠŸ'); 
                        loadConfig(); 
                    }
                    return true; 
                }
                else { 
                    if (!skipReload) showToast(r.error || 'æ“ä½œå¤±è´¥', true); 
                    return false; 
                }
            } catch (e) { 
                if (!skipReload) showToast('è¯·æ±‚å¤±è´¥', true); 
                return false; 
            }
        }

        // Flat
        async function flatClassAdd() {
            const v = document.getElementById('flatClass').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥ç±»å', true); return; }
            if (await post('/flat/class/add', 'className=' + encodeURIComponent(v)))
                document.getElementById('flatClass').value = '';
        }
        async function flatPackageAdd() {
            const v = document.getElementById('flatPackage').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥åŒ…å', true); return; }
            if (await post('/flat/package/add', 'packageName=' + encodeURIComponent(v)))
                document.getElementById('flatPackage').value = '';
        }
        async function flatConfigSave() {
            const threshold = document.getElementById('flatThreshold').value.trim();
            const trigger = document.getElementById('flatTrigger').value;

            let success = true;
            // æ‰¹é‡æ›´æ–°
            if (threshold) {
                if (!await post('/flat/threshold', 'threshold=' + encodeURIComponent(threshold), true)) {
                    success = false;
                }
            }
            if (!await post('/flat/trigger', 'trigger=' + trigger, true)) {
                success = false;
            }

            if (success) {
                showToast('Flat é…ç½®å·²ä¿å­˜');
                loadConfig();
            } else {
                showToast('éƒ¨åˆ†é…ç½®ä¿å­˜å¤±è´¥', true);
            }
        }

        // Tree
        async function treeEntryAdd() {
            const v = document.getElementById('treeEntry').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥å…¥å£æ–¹æ³•', true); return; }
            if (await post('/tree/entry/add', 'method=' + encodeURIComponent(v)))
                document.getElementById('treeEntry').value = '';
        }
        async function treePackageAdd() {
            const v = document.getElementById('treePackage').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥åŒ…å', true); return; }
            if (await post('/tree/package/add', 'packageName=' + encodeURIComponent(v)))
                document.getElementById('treePackage').value = '';
        }
        async function treeConfigSave() {
            const threshold = document.getElementById('treeThreshold').value.trim();
            const trigger = document.getElementById('treeTrigger').value;

            let success = true;
            if (threshold) {
                if (!await post('/tree/threshold', 'threshold=' + encodeURIComponent(threshold), true)) {
                    success = false;
                }
            }
            if (!await post('/tree/trigger', 'trigger=' + trigger, true)) {
                success = false;
            }

            if (success) {
                showToast('Tree é…ç½®å·²ä¿å­˜');
                loadConfig();
            } else {
                showToast('éƒ¨åˆ†é…ç½®ä¿å­˜å¤±è´¥', true);
            }
        }

        // Snapshot
        async function snapshotSave() {
            const params = new URLSearchParams();
            params.append('enabled', document.getElementById('snapshotEnabled').value);
            params.append('mode', document.getElementById('snapshotMode').value);
            // dir is immutable
            await post('/snapshot/config', params.toString());
        }

        // Exception
        async function exceptionIncludeAdd() {
            const v = document.getElementById('exceptionInclude').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥å¼‚å¸¸ç±»å‹', true); return; }
            if (await post('/exception/include/add', 'pattern=' + encodeURIComponent(v)))
                document.getElementById('exceptionInclude').value = '';
        }
        async function exceptionExcludeAdd() {
            const v = document.getElementById('exceptionExclude').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥å¼‚å¸¸ç±»å‹', true); return; }
            if (await post('/exception/exclude/add', 'pattern=' + encodeURIComponent(v)))
                document.getElementById('exceptionExclude').value = '';
        }
        async function exceptionDepthSet() {
            const v = document.getElementById('exceptionDepth').value.trim();
            if (!v) { showToast('è¯·è¾“å…¥å †æ ˆæ·±åº¦', true); return; }
            if (await post('/exception/depth', 'depth=' + encodeURIComponent(v)))
                document.getElementById('exceptionDepth').value = '';
        }

        loadConfig();
    </script>
</body>

</html>